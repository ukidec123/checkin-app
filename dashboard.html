<!-- dashboard.html (‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠) -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    select, button { margin: 0.5rem 0; }
  </style>
</head>
<body>
  <h1>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Å‡∏ä‡∏∑‡πà‡∏≠</h1>
  <label for="filterDate">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: </label>
  <select id="filterDate"></select>

  <label for="filterStatus">‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: </label>
  <select id="filterStatus">
    <option value="">-- ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>
    <option value="‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß">‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß</option>
    <option value="üö´ ‡∏•‡∏≤">üö´ ‡∏•‡∏≤</option>
    <option value="‚ùå ‡∏Ç‡∏≤‡∏î">‚ùå ‡∏Ç‡∏≤‡∏î</option>
    <option value="üè† ‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°">üè† ‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°</option>
    <option value="‚ùå ‡πÑ‡∏°‡πà‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°">‚ùå ‡πÑ‡∏°‡πà‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°</option>
  </select>

  <table id="reportTable">
    <thead>
      <tr>
        <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠</th>
        <th>‡∏´‡πâ‡∏≠‡∏á</th>
        <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
      </tr>
    </thead>
    <tbody id="reportBody"></tbody>
  </table>

  <button onclick="deleteDay()">üóë ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>

  <canvas id="barChart" width="400" height="200"></canvas>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbzzwGoC-jjV-tDS_Uh7B2t3ZkULJvEKzZkrjS8FCmGJ98i2abmINfwrn73A4R1SZ7Jp/exec";
    let rawData = {};

    async function loadData() {
      try {
        const res = await fetch(webAppUrl + '?mode=dashboard');
        rawData = await res.json();
        updateDateOptions();
        renderChart();
      } catch (err) {
        alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      }
    }

    function updateDateOptions() {
      const dates = Object.keys(rawData);
      const dateSelect = document.getElementById("filterDate");
      dateSelect.innerHTML = dates.map(d => `<option value="${d}">${d}</option>`).join("");
      dateSelect.onchange = renderTable;
      document.getElementById("filterStatus").onchange = renderTable;
      if (dates.length > 0) {
        dateSelect.value = dates[0];
        renderTable();
      }
    }

    function renderTable() {
      const date = document.getElementById("filterDate").value;
      const status = document.getElementById("filterStatus").value;
      const records = rawData[date] || [];
      const tbody = document.getElementById("reportBody");
      tbody.innerHTML = "";

      records.filter(r => !status || r.status === status).forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${r.no}</td><td>${r.name}</td><td>${r.class}</td><td>${r.status}</td><td>${r.time}</td>`;
        tbody.appendChild(tr);
      });
    }

    async function deleteDay() {
      const date = document.getElementById("filterDate").value;
      if (!confirm(`‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date}?`)) return;
      const res = await fetch(webAppUrl + `?mode=delete&date=${date}`);
      const result = await res.text();
      if (result === "OK") {
        alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß");
        loadData();
      } else {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }

    function renderChart() {
      const nameMap = {};
      Object.values(rawData).flat().forEach(r => {
        if (r.status === "‚ùå ‡πÑ‡∏°‡πà‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°" || r.status === "‚ùå ‡∏Ç‡∏≤‡∏î") {
          nameMap[r.name] = (nameMap[r.name] || 0) + 1;
        }
      });
      const ctx = document.getElementById("barChart");
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(nameMap),
          datasets: [{
            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏ñ‡∏ß/‡πÇ‡∏Æ‡∏°‡∏£‡∏π‡∏°',
            data: Object.values(nameMap),
            backgroundColor: 'tomato'
          }]
        }
      });
    }

    loadData();
  </script>
</body>
</html>
